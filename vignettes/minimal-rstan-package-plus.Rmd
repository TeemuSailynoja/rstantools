---
title: "Step-by-step guide for creating a Stan-enabled R package"
author: "Martin Lysy"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
params:
  EVAL: !r identical(Sys.getenv("NOT_CRAN"), "true")
vignette: >
  %\VignetteIndexEntry{Stan-enabled package authoring: Step-by-step guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, eval = FALSE, include = FALSE, echo = FALSE}
# to render vignette while working on it 
rmarkdown::render("minimal-rstan-package-plus.Rmd")

```

```{r, echo = FALSE}
# make sure package can be created
pkg_name <- "RStanTest" # name of package
pkg_path <- tempdir() # path to directory where package folder should be created
if(file.exists(file.path(pkg_path, pkg_name))) {
  system(command = paste0("rm -rf ", file.path(pkg_path, pkg_name)))
}
```

## Creating a Stan-enabled package from scratch

This is done with the function `rstan_package_skeleton_plus()`.  To illustrate, let's create a package out of the files distributed with **rstantools** in the following directory:

```{r}
require(rstantools)
stan_path <- system.file("include", "rstan_package_skeleton_plus",
                         package = "rstantools")
stan_path
```

You can inspect the contents of this folder to see exactly what the package files consist of.  To create a package we run the following commands:

```{r}
pkg_name <- "RStanTest" # name of package
pkg_path <- tempdir() # path to directory where package folder should be created
# R files to add to package
code_files <- file.path(stan_path, c("RStanTest-package.R", "postsamp.R"))
# stan files to add to package
stan_files <- file.path(stan_path, c("SimpleModel.stan", "SimpleModel2.stan"))

# create package
rstan_package_skeleton_plus(name = pkg_name,
                            path = pkg_path,
                            code_files = code_files,
                            stan_files = stan_files)
```

### Use of roxygen2

If you are not using **roxygen2** to create package documentation, you can skip this step.  If you are using it, as this example does, then (for now) you need to edit the package `NAMESPACE` file by running the following code:
```{r}
# current value of NAMESPACE file
namespace_lines <- readLines(file.path(pkg_path, pkg_name, "NAMESPACE"))
# modify so roxygen2 will overwrite it
cat("# Generated by roxygen2: do not edit by hand\n",
    namespace_lines, sep = "\n",
    file = file.path(pkg_path, pkg_name, "NAMESPACE"))
```
The the package documentation will be generated by running the command
```{r}
devtools::document(file.path(pkg_path, pkg_name))
```

### Checking that package installed correctly

Here this is done by adding **testthat** unit tests to the package, which verify that the Stan log-posterior and an **R** implementation differ by no more than an additive constant.
```{r}
# add unit tests to package
devtools::use_testthat(file.path(pkg_path, pkg_name))
file.copy(from = file.path(stan_path, "test-postsamp.R"),
          to = file.path(pkg_path, pkg_name,
                         "tests", "testthat", "test-postsamp.R"))
```

Now the package can be installed and its tests can be run:
```{r}
devtools::install(file.path(pkg_path, pkg_name)) # install package

# run package tests
require(testthat)
testthat::test_package(pkg_name, reporter = "progress")
```

## Add Stan functionality to an existing package

If you have an existing package and wish to add `.stan` files, this can be accomplished with the functions:

i.  `use_rstan()`, which adds the necessary folders and files to your package and
ii. `rstan_config()`, which must be re-run every time any `.stan` files in the package are added/removed/modified (NOTE: this requirement is in the process of being removed).

To illustrate, let's create the previous package without any of the Stan files, then add Stan functionality to the newly created package.

```{r}
# delete existing package
# WARNING: run this command issues no warnings so proceed with caution!
system(command = paste0("rm -rf ", file.path(pkg_path, pkg_name)))

# re-create package without stan_files using package.skeleton
package.skeleton(name = pkg_name,
                 path = pkg_path,
                 code_files = code_files)
# delete contents of "man" so roxygen2 can be used
file.remove(list.files(file.path(pkg_path, pkg_name, "man"),
                       full.names = TRUE))

# add unit tests to package
devtools::use_testthat(file.path(pkg_path, pkg_name))
file.copy(from = file.path(stan_path, "test-postsamp.R"),
          to = file.path(pkg_path, pkg_name,
                         "tests", "testthat", "test-postsamp.R"))
```
Now we can add the Stan files and functionality with the following command:
```{r}
# add stan functionality
rstantools::use_rstan(file.path(pkg_path, pkg_name))
# add stan files
file.copy(from = stan_files,
          to = file.path(pkg_path, pkg_name,
                         "inst", "stan", basename(stan_files)))
# run this any time Stan files are added/removed/modified
rstantools::rstan_config(file.path(pkg_path, pkg_name))
```

Finally we can install the package and run its tests:
```{r}
# modify NAMESPACE so roxygen2 can be used
namespace_lines <- readLines(file.path(pkg_path, pkg_name, "NAMESPACE"))
cat("# Generated by roxygen2: do not edit by hand\n",
    namespace_lines,
    sep = "\n",
    file = file.path(pkg_path, pkg_name, "NAMESPACE"))

devtools::document(file.path(pkg_path, pkg_name)) # roxygen2
devtools::install(file.path(pkg_path, pkg_name)) # install package

# tests
testthat::test_package(pkg_name, reporter = "progress")
```
